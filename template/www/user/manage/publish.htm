<style>
.form-group { width: 100%; }
#cid, #keywords { width: 360px; }
#title { width: 336px; }
#keywords { width: 410px; }
#description { height: 300px; width: 95%; padding: 5px; }
.manage-publish { margin-left: 20px; }
.creative { width: 220px; display: inline-block; }
.creative .bootstrap-switch { border-radius: 0px 5px 5px 0px !important; border-color: #ccc !important; width: 106px !important; height: 35px !important; }
.creative .bootstrap-switch-container span { width: 53px !important; height: 35px !important; }
.creative .bootstrap-switch-container .bootstrap-switch-primary { border-radius: 0px !important; }
#source-box { width: 360px; display: inline-block; }
#source-box .form-control { width: 320px; }
</style>
<link href="<!--{$site.urls.tpl}-->/static/css/bootstrap-switch.min.css" type="text/css" rel="stylesheet" />
<script src="<!--{$site.urls.tpl}-->/static/js/bootstrap-switch.min.js"></script>

<script src="<!--{$iCMS.UI}-->/iCMS.user.editor-6.0.0.js" type="text/javascript" charset="utf-8"></script>
<script src="<!--{$iCMS.UI}-->/ueditor/ueditor.all.min.js" type="text/javascript" charset="utf-8"></script>

<input name="id" type="hidden" value="<!--{$article.id}-->" />
<input name="ucid" id="ucid" type="hidden" value="<!--{$article.ucid}-->" />
<input name="_ucid" type="hidden" value="<!--{$article.ucid}-->" />
<input name="_cid" type="hidden" value="<!--{$article.cid}-->" />
<input name="mobile" type="hidden" value="0" />
<div class="title"><span>发表文章</span></div>
<div class="manage-publish form-inline" id="publish">
    <div class="form-group">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="cid" class="control-label">栏 目</label>
            </div>
            <select name="cid" id="cid" class="form-control">
                <option value="0"> == 请选择所属栏目 == </option>
                <!--{$option}-->
            </select>
        </div>
        <button class="btn btn-primary iCMS_user_publish" type="submit"><i class="fa fa-check"></i> 提交</button>
    </div>
    <div class="mb10"></div>
    <div class="form-group">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="title" class="control-label">标 题</label>
            </div>
            <input class="form-control" name="title" id="title" type="text" value="<!--{$article.title}-->">
            <div class="input-group-addon">
                <a class="dropdown-toggle" data-toggle="dropdown" tabindex="-1"> <span class="caret"></span> <span id="uc_select">默认分类</span></a>
                <ul class="dropdown-menu">
                    <!--{iCMS:user:category loop="true" userid="$user.uid" appid="$iCMS.APPID.ARTICLE"}-->
                    <li>
                        <a href="javascript:;" cid="<!--{$user_category.cid}-->" class="user_category">
                            <!--{$user_category.name}-->
                        </a>
                    </li>
                    <!--{/iCMS}-->
                    <li id="user_category_0"><a href="javascript:;" cid="0" class="user_category">默认分类</a></li>
                    <li class="divider"></li>
                    <li><a href="javascript:;" title="添加分类" id="add_category" class="btn"><i class="fa fa-edit"></i> 添加分类</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mb10"></div>
    <div class="form-group">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="keywords" class="control-label">关键字</label>
            </div>
            <input class="form-control" name="keywords" id="keywords" type="text" value="<!--{$article.keywords}-->" onkeyup="javascript:this.value=this.value.replace(/，/ig,',');">
        </div>
    </div>
    <div class="mb10"></div>
    <div class="form-group">
        <label for="description" class="control-label">简 介</label>
        <div class="mb10"></div>
        <textarea name="description" id="description" class="form-control"><!--{$article.description}--></textarea>
    </div>
    <div class="mb10"></div>
    <div class="form-group creative">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="article-type" class="control-label">文章类型？</label>
            </div>
            <div class="switch" id="article-type">
                <input type="checkbox" name="creative" data-on-text="原创" data-off-text="转贴" <!--{if $article.creative}--> checked
                <!--{/if}-->/>
            </div>
        </div>
    </div>
    <div class="form-group <!--{if $article.creative}-->hide<!--{/if}-->" id="source-box">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="source" class="control-label">出 处</label>
            </div>
            <input class="form-control" name="source" id="source" type="text" value="<!--{$article.source}-->">
        </div>
    </div>
    <div class="mb10"></div>
    <script type="text/plain" id="editor" style="width:100%;height:360px;">
        <!--{$article_data.body}-->
    </script>
    <div class="mb10"></div>
    <!--{if $iCMS.CONFIG.user.post.seccode }-->
    <div class="form-group">
        <div class="input-group">
            <div class="input-group-addon">
                <label for="seccode" class="control-label">验证码：</label>
            </div>
            <input type="text" maxlength="4" name="seccode" class="seccode form-control" id="seccode" placeholder="请输入验证码">
        </div>
        <img src="<!--{iCMS:router url='/api/public/seccode'}-->" alt="验证码" class="seccode-img r3" />
        <a href="javascript:;" class="seccode-text" style="float: none">换一张</a>
    </div>
    <!--{/if}-->
    <div class="mb10"></div>
    <div class="form-group">
        <button class="btn btn-lg btn-primary iCMS_user_publish" type="submit">
            <i class="fa fa-check"></i> 提 交
        </button>
    </div>
</div>
<div id="add_category_box" style="display: none;">
    <input class="span3" id="newcategoryname" type="text" placeholder="请输入分类名称">
</div>
<script type="text/javascript">
// var ed = UE.getEditor('editor');
$(function() {
    var publish = $("#publish");

    $('[name="creative"]',publish).bootstrapSwitch()
    .on('switchChange.bootstrapSwitch',
        function(event, state) {
            if (state) {
                $('#source-box').hide();
                $('#source').val('');
            } else {
                $('#source-box').css({
                    display: 'inline-block',
                });
            }
        }
    );
    <!--{if $article.cid}-->
    $("#cid",publish).val("<!--{$article.cid}-->");
    <!--{/if}-->

    <!--{if $article.ucid}-->
    var uc = $("[cid='<!--{$article.ucid}-->']",publish);
    uc.parent().addClass('active');
    $("#uc_select").text(uc.text());
    <!--{/if}-->

    $(".iCMS_user_publish").click(function() {
        if ($("#cid option:selected").val() == "0") {
            $("#cid").focus();
            iCMS.alert("请选择所属栏目");
            return false;
        }
        if ($("#title").val() == '') {
            $("#title").focus();
            iCMS.alert("标题不能为空!");
            return false;
        }
        <!--{if $iCMS.CONFIG.user.post.seccode }-->
        if ($(".seccode").val() == '') {
            $(".seccode").focus();
            iCMS.alert("验证码不能为空!");
            return false;
        }
        <!--{/if}-->
        if (!ed.hasContents()) {
            ed.focus();
            iCMS.alert("内容不能为空!");
            return false;
        }
    });
    // $('#article-type').on('switch-change', function(e, data) {
    //     var value = data.value;
    //     if (data.value) {
    //         $('#source-box').hide();
    //         $('#source').val('');
    //     } else {
    //         $('#source-box').css({
    //             display: 'inline-block',
    //         });
    //     }
    // });
    $(document).on('click', '.user_category', function(event) {
        event.preventDefault();
        var $this = $(this),
            cid = $this.attr("cid"),
            name = $this.text();
        $("#ucid").val(cid);
        $("#uc_select").text(name);
        $(".user_category").parent().removeClass('active');
        $this.parent().addClass('active');
        $this.parent().parent().parent().removeClass("open");
        return false;
    });
    $('#add_category').click(function() {
        iCMS.dialog({
            follow: document.getElementById('user_category'),
            title: '添加新分类',
            content: document.getElementById('add_category_box'),
            okValue: '添加',
            ok: function() {
                var a = $("#newcategoryname"),
                    n = a.val(),
                    d = this;
                if (n == "") {
                    iCMS.alert("请输入分类名称!");
                    a.focus();
                    return false;
                } else {
                    $.post('<!--{iCMS:router url=' / user '}-->', {
                            'action': 'add_category',
                            name: n
                        },
                        function(j) {
                            if (j.code) {
                                d.content(j.msg)
                                    .button([{
                                        value: '完成',
                                        callback: function() {
                                            $("#user_category_0").before('<li><a href="javascript:;" cid="' + j.forward + '" class="user_category">' + n + '</a></li>');
                                        },
                                        autofocus: true
                                    }]);
                            } else {
                                alert(j.msg);
                                a.focus();
                                return false;
                            }
                        }, "json");
                }
                return false;
            }
        });
    });
});
</script>
